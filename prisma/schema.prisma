// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==================== COMPANIES ====================

model CompanyMaster {
  companyId                   String   @id @default(uuid()) @map("company_id")
  companyName                 String   @map("company_name")
  companyType                 String   @map("company_type") // RADIAN | MERCHANT | SUPPLIER | BROKER
  companyStatus               String   @default("ACTIVE") @map("company_status")
  isClient                    Boolean  @default(false) @map("is_client")
  termsAndConditionsFile      String?  @map("terms_and_conditions_file")
  trainingContentFile         String?  @map("training_content_file")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  designations                DesignationMaster[]
  userAssignments             UserCompanyAssignment[]
  availablePermissions        CompanyAvailablePermission[]
  relationshipsAsFrom         CompanyRelationship[] @relation("FromCompany")
  relationshipsAsTo           CompanyRelationship[] @relation("ToCompany")
  permissionOverrides         UserPermissionOverride[]
  files                       FileMaster[]
  auditLogs                   AuditLog[]

  @@map("company_master")
}

model CompanyRelationship {
  companyRelationshipId       String   @id @default(uuid()) @map("company_relationship_id")
  fromCompanyId               String   @map("from_company_id")
  toCompanyId                 String   @map("to_company_id")
  relationshipType            String   @map("relationship_type") // MERCHANT_SUPPLIER | BROKER_SUPPLIER | PARTNER
  relationshipStatus          String   @default("ACTIVE") @map("relationship_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  fromCompany                 CompanyMaster @relation("FromCompany", fields: [fromCompanyId], references: [companyId])
  toCompany                   CompanyMaster @relation("ToCompany", fields: [toCompanyId], references: [companyId])
  userAssignments             UserCompanyAssignment[]
  permissionOverrides         UserPermissionOverride[]

  @@map("company_relationship")
}

// ==================== USERS ====================

model UserMaster {
  userId                      String   @id @default(uuid()) @map("user_id")
  firstName                   String   @map("first_name")
  middleName                  String?  @map("middle_name")
  lastName                    String   @map("last_name")
  email                       String   @unique
  password                    String   // Hashed password for prototype
  phone                       String?
  status                      String   @default("ACTIVE")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  companyAssignments          UserCompanyAssignment[]
  grantedPermissions          CompanyAvailablePermission[]
  permissionOverrides         UserPermissionOverride[] @relation("PermissionOverrides")
  createdOverrides            UserPermissionOverride[] @relation("OverrideCreator")
  uploadedFiles               FileMaster[]
  auditLogs                   AuditLog[]

  @@map("user_master")
}

// ==================== ROLES (DESIGNATIONS) ====================

model DesignationMaster {
  designationId               String   @id @default(uuid()) @map("designation_id")
  companyId                   String   @map("company_id")
  designationName             String   @map("designation_name")
  designationStatus           String   @default("ACTIVE") @map("designation_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  company                     CompanyMaster @relation(fields: [companyId], references: [companyId])
  userAssignments             UserCompanyAssignment[]
  permissions                 DesignationPermission[]

  @@map("designation_master")
}

// ==================== USER ASSIGNMENTS (CORE JUNCTION) ====================

model UserCompanyAssignment {
  userCompanyAssignmentId     String   @id @default(uuid()) @map("user_company_assignment_id")
  userId                      String   @map("user_id")
  companyId                   String   @map("company_id")
  designationId               String   @map("designation_id")
  companyRelationshipId       String?  @map("company_relationship_id") // NULL = all relationships
  assignmentStatus            String   @default("ACTIVE") @map("assignment_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  user                        UserMaster @relation(fields: [userId], references: [userId])
  company                     CompanyMaster @relation(fields: [companyId], references: [companyId])
  designation                 DesignationMaster @relation(fields: [designationId], references: [designationId])
  companyRelationship         CompanyRelationship? @relation(fields: [companyRelationshipId], references: [companyRelationshipId])

  @@map("user_company_assignments")
}

// ==================== PERMISSIONS ====================

model PermissionMaster {
  permissionId                String   @id @default(uuid()) @map("permission_id")
  permissionKey               String   @unique @map("permission_key")
  permissionDescription       String   @map("permission_description")
  permissionCategory          String   @map("permission_category") // DEALS | REPORTS | USERS | SETTINGS | ADMIN
  permissionStatus            String   @default("ACTIVE") @map("permission_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  companyAvailablePermissions CompanyAvailablePermission[]
  designationPermissions      DesignationPermission[]
  userOverrides               UserPermissionOverride[]

  @@map("permission_master")
}

model CompanyAvailablePermission {
  companyAvailablePermissionId String  @id @default(uuid()) @map("company_available_permission_id")
  companyId                    String  @map("company_id")
  permissionId                 String  @map("permission_id")
  grantedByUserId              String? @map("granted_by_user_id")
  createdAt                    DateTime @default(now()) @map("created_at")

  // Relations
  company                      CompanyMaster @relation(fields: [companyId], references: [companyId])
  permission                   PermissionMaster @relation(fields: [permissionId], references: [permissionId])
  grantedBy                    UserMaster? @relation(fields: [grantedByUserId], references: [userId])

  @@unique([companyId, permissionId])
  @@map("company_available_permissions")
}

model DesignationPermission {
  designationPermissionId     String   @id @default(uuid()) @map("designation_permission_id")
  designationId               String   @map("designation_id")
  permissionId                String   @map("permission_id")
  createdAt                   DateTime @default(now()) @map("created_at")

  // Relations
  designation                 DesignationMaster @relation(fields: [designationId], references: [designationId])
  permission                  PermissionMaster @relation(fields: [permissionId], references: [permissionId])

  @@unique([designationId, permissionId])
  @@map("designation_permissions")
}

// ==================== USER PERMISSION OVERRIDES ====================

model UserPermissionOverride {
  userPermissionOverrideId    String   @id @default(uuid()) @map("user_permission_override_id")
  userId                      String   @map("user_id")
  companyId                   String   @map("company_id")
  companyRelationshipId       String?  @map("company_relationship_id") // Optional scope
  permissionId                String   @map("permission_id")
  effect                      String   @map("effect") // ALLOW | DENY
  reason                      String?  @map("reason") // Why this override exists
  overrideStatus              String   @default("ACTIVE") @map("override_status")
  createdByUserId             String?  @map("created_by_user_id")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  user                        UserMaster @relation("PermissionOverrides", fields: [userId], references: [userId])
  company                     CompanyMaster @relation(fields: [companyId], references: [companyId])
  companyRelationship         CompanyRelationship? @relation(fields: [companyRelationshipId], references: [companyRelationshipId])
  permission                  PermissionMaster @relation(fields: [permissionId], references: [permissionId])
  createdBy                   UserMaster? @relation("OverrideCreator", fields: [createdByUserId], references: [userId])

  @@unique([userId, companyId, companyRelationshipId, permissionId])
  @@map("user_permission_overrides")
}

// ==================== FILE MANAGEMENT ====================

model FileMaster {
  fileId                      String   @id @default(uuid()) @map("file_id")
  fileName                    String   @map("file_name")
  originalFileName            String   @map("original_file_name")
  contentType                 String   @map("content_type") // MIME type
  fileSize                    Int      @map("file_size") // bytes
  storageKey                  String   @map("storage_key") // Supabase storage path
  storageUrl                  String?  @map("storage_url") // Public URL if applicable
  entityType                  String?  @map("entity_type") // e.g., COMPANY, USER, DEAL
  entityId                    String?  @map("entity_id") // ID of related entity
  uploadedByUserId            String   @map("uploaded_by_user_id")
  companyId                   String?  @map("company_id") // File belongs to company
  fileStatus                  String   @default("ACTIVE") @map("file_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  uploadedBy                  UserMaster @relation(fields: [uploadedByUserId], references: [userId])
  company                     CompanyMaster? @relation(fields: [companyId], references: [companyId])

  @@map("file_master")
}

// ==================== AUDIT LOG ====================

model AuditLog {
  auditLogId                  String   @id @default(uuid()) @map("audit_log_id")
  actorUserId                 String?  @map("actor_user_id") // Who performed the action (null for system)
  actorCompanyId              String?  @map("actor_company_id") // Context company
  actionKey                   String   @map("action_key") // e.g., USER_CREATED, PERMISSION_GRANTED
  actionCategory              String   @map("action_category") // AUTH | USER | COMPANY | PERMISSION | SYSTEM
  entityType                  String   @map("entity_type") // e.g., USER, COMPANY, DESIGNATION
  entityId                    String   @map("entity_id") // ID of affected entity
  entityName                  String?  @map("entity_name") // Human-readable name for context
  previousValue               Json?    @map("previous_value") // State before change
  newValue                    Json?    @map("new_value") // State after change
  metadata                    Json?    @map("metadata") // Additional context
  ipAddress                   String?  @map("ip_address")
  userAgent                   String?  @map("user_agent")
  createdAt                   DateTime @default(now()) @map("created_at")

  // Relations
  actor                       UserMaster? @relation(fields: [actorUserId], references: [userId])
  actorCompany                CompanyMaster? @relation(fields: [actorCompanyId], references: [companyId])

  @@index([actorUserId])
  @@index([entityType, entityId])
  @@index([actionKey])
  @@index([createdAt])
  @@map("audit_log")
}

// ==================== INVITATIONS ====================

model Invitation {
  invitationId                String   @id @default(uuid()) @map("invitation_id")
  email                       String   @map("email")
  token                       String   @unique @map("token")
  invitedByUserId             String   @map("invited_by_user_id")
  companyId                   String   @map("company_id")
  designationId               String   @map("designation_id")
  companyRelationshipId       String?  @map("company_relationship_id")
  expiresAt                   DateTime @map("expires_at")
  acceptedAt                  DateTime? @map("accepted_at")
  invitationStatus            String   @default("PENDING") @map("invitation_status") // PENDING | ACCEPTED | EXPIRED | REVOKED
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([token])
  @@index([companyId])
  @@map("invitations")
}

// ==================== POLICIES (ABAC) ====================

model PolicyMaster {
  policyId                    String   @id @default(uuid()) @map("policy_id")
  policyName                  String   @map("policy_name")
  policyDescription           String?  @map("policy_description")
  policyType                  String   @map("policy_type") // ALLOW | DENY
  priority                    Int      @default(0) @map("priority") // Higher = evaluated first
  policyStatus                String   @default("ACTIVE") @map("policy_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  conditions                  PolicyCondition[]
  assignments                 PolicyAssignment[]

  @@map("policy_master")
}

model PolicyCondition {
  policyConditionId           String   @id @default(uuid()) @map("policy_condition_id")
  policyId                    String   @map("policy_id")
  attributeType               String   @map("attribute_type") // USER | COMPANY | RESOURCE | ENVIRONMENT
  attributeKey                String   @map("attribute_key") // e.g., companyType, dealAmount, timeOfDay
  operator                    String   @map("operator") // EQUALS | NOT_EQUALS | IN | NOT_IN | GREATER_THAN | LESS_THAN | CONTAINS
  attributeValue              Json     @map("attribute_value") // Value to compare against
  createdAt                   DateTime @default(now()) @map("created_at")

  // Relations
  policy                      PolicyMaster @relation(fields: [policyId], references: [policyId], onDelete: Cascade)

  @@map("policy_conditions")
}

model PolicyAssignment {
  policyAssignmentId          String   @id @default(uuid()) @map("policy_assignment_id")
  policyId                    String   @map("policy_id")
  targetType                  String   @map("target_type") // COMPANY | DESIGNATION | USER | COMPANY_TYPE
  targetId                    String   @map("target_id") // ID of target entity
  assignmentStatus            String   @default("ACTIVE") @map("assignment_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  policy                      PolicyMaster @relation(fields: [policyId], references: [policyId], onDelete: Cascade)

  @@unique([policyId, targetType, targetId])
  @@map("policy_assignments")
}

// ==================== DEALS ====================

model DealType {
  dealTypeId                  String   @id @default(uuid()) @map("deal_type_id")
  dealTypeName                String   @map("deal_type_name") // e.g., PURCHASE_ORDER, INVOICE, CONTRACT
  dealTypeDescription         String?  @map("deal_type_description")
  dealTypeStatus              String   @default("ACTIVE") @map("deal_type_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  phases                      DealPhase[]
  deals                       Deal[]

  @@map("deal_types")
}

model DealPhase {
  dealPhaseId                 String   @id @default(uuid()) @map("deal_phase_id")
  dealTypeId                  String   @map("deal_type_id")
  phaseName                   String   @map("phase_name") // e.g., DRAFT, PENDING_APPROVAL, APPROVED, IN_PROGRESS, COMPLETED
  phaseOrder                  Int      @map("phase_order")
  phaseDescription            String?  @map("phase_description")
  phaseStatus                 String   @default("ACTIVE") @map("phase_status")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  dealType                    DealType @relation(fields: [dealTypeId], references: [dealTypeId])
  deals                       Deal[]

  @@map("deal_phases")
}

model Deal {
  dealId                      String   @id @default(uuid()) @map("deal_id")
  dealNumber                  String   @unique @map("deal_number") // Human-readable identifier
  dealTypeId                  String   @map("deal_type_id")
  currentPhaseId              String   @map("current_phase_id")
  companyRelationshipId       String   @map("company_relationship_id") // Which B2B relationship this deal belongs to
  ownerCompanyId              String   @map("owner_company_id") // Primary company that owns/created the deal
  counterpartyCompanyId       String   @map("counterparty_company_id") // The other company in the deal
  dealTitle                   String   @map("deal_title")
  dealDescription             String?  @map("deal_description")
  dealAmount                  Decimal? @map("deal_amount") @db.Decimal(15, 2)
  dealCurrency                String   @default("USD") @map("deal_currency")
  startDate                   DateTime? @map("start_date")
  endDate                     DateTime? @map("end_date")
  dealStatus                  String   @default("ACTIVE") @map("deal_status") // ACTIVE | COMPLETED | CANCELLED | ON_HOLD
  metadata                    Json?    @map("metadata") // Flexible field for deal-specific data
  createdByUserId             String   @map("created_by_user_id")
  createdAt                   DateTime @default(now()) @map("created_at")
  updatedAt                   DateTime @updatedAt @map("updated_at")

  // Relations
  dealType                    DealType @relation(fields: [dealTypeId], references: [dealTypeId])
  currentPhase                DealPhase @relation(fields: [currentPhaseId], references: [dealPhaseId])
  participants                DealParticipant[]
  history                     DealHistory[]

  @@index([ownerCompanyId])
  @@index([counterpartyCompanyId])
  @@index([companyRelationshipId])
  @@index([dealStatus])
  @@index([createdAt])
  @@map("deals")
}

model DealParticipant {
  dealParticipantId           String   @id @default(uuid()) @map("deal_participant_id")
  dealId                      String   @map("deal_id")
  userId                      String   @map("user_id")
  companyId                   String   @map("company_id") // Which company this participant represents
  participantRole             String   @map("participant_role") // OWNER | APPROVER | VIEWER | COLLABORATOR
  participantStatus           String   @default("ACTIVE") @map("participant_status")
  addedAt                     DateTime @default(now()) @map("added_at")

  // Relations
  deal                        Deal @relation(fields: [dealId], references: [dealId], onDelete: Cascade)

  @@unique([dealId, userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("deal_participants")
}

model DealHistory {
  dealHistoryId               String   @id @default(uuid()) @map("deal_history_id")
  dealId                      String   @map("deal_id")
  actionType                  String   @map("action_type") // CREATED | PHASE_CHANGED | UPDATED | COMMENT | ATTACHMENT
  previousPhaseId             String?  @map("previous_phase_id")
  newPhaseId                  String?  @map("new_phase_id")
  changedByUserId             String   @map("changed_by_user_id")
  changedByCompanyId          String   @map("changed_by_company_id")
  changeDescription           String?  @map("change_description")
  previousValue               Json?    @map("previous_value")
  newValue                    Json?    @map("new_value")
  createdAt                   DateTime @default(now()) @map("created_at")

  // Relations
  deal                        Deal @relation(fields: [dealId], references: [dealId], onDelete: Cascade)

  @@index([dealId])
  @@index([createdAt])
  @@map("deal_history")
}
